<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>HEXA Â±¨ÊÄßÊ®°Êì¨Âô®</title>
  
  <!-- ËºâÂÖ• Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- ËºâÂÖ• Babel ‰ª•‰æøÂú®ÁÄèË¶ΩÂô®‰∏≠Ëß£Êûê JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    /* Èö±ËóèÊªæÂãïÊ¢ùÁöÑËºîÂä©Ê®£Âºè */
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="bg-slate-950 text-slate-200">
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useMemo, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
    import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
    import { RefreshCw, RotateCcw, Info, Coins, Clock, Zap, Target, TrendingUp, X, ArrowUpDown, ListChecks, Calculator, Hourglass, Settings, Copy, Link, AlertTriangle, Trash2, CheckCircle, Globe, ChevronRight, ChevronLeft, Smartphone, MapPin, XCircle } from 'https://esm.sh/lucide-react@0.292.0';

    // ==========================================
    // 1. ÂÆâÂÖ®Áí∞Â¢ÉËàáÈò≤Ë≠∑Â±§ (Safe Storage + Memory Fallback)
    // ==========================================

    const memCache = {};

    const safeStorage = {
      get: (key) => {
        try { if (typeof window !== 'undefined' && window.localStorage) return window.localStorage.getItem(key) || memCache[key] || null; } catch (e) {}
        return memCache[key] || null;
      },
      set: (key, value) => {
        memCache[key] = value;
        try { if (typeof window !== 'undefined' && window.localStorage) window.localStorage.setItem(key, value); } catch (e) {}
      },
      rem: (key) => {
        delete memCache[key];
        try { if (typeof window !== 'undefined' && window.localStorage) window.localStorage.removeItem(key); } catch (e) {}
      },
      clear: () => {
        for (let key in memCache) delete memCache[key];
        try { if (typeof window !== 'undefined' && window.localStorage) window.localStorage.clear(); } catch (e) {}
      },
      test: () => {
        try { const testKey = '__test_storage__'; window.localStorage.setItem(testKey, testKey); window.localStorage.removeItem(testKey); return true; } catch (e) { return false; }
      }
    };

    class ErrorBoundary extends React.Component {
      constructor(props) { super(props); this.state = { hasError: false, error: null }; }
      static getDerivedStateFromError(error) { return { hasError: true, error }; }
      componentDidCatch(error, errorInfo) { console.error("App Crashed:", error, errorInfo); }
      render() {
        if (this.state.hasError) {
          return (
            <div className="min-h-screen bg-slate-950 text-slate-200 p-8 font-sans flex flex-col items-center justify-center">
              <div className="bg-red-950/30 border border-red-900 rounded-2xl p-6 max-w-2xl w-full text-center">
                <AlertTriangle className="w-12 h-12 text-red-500 mx-auto mb-4" />
                <h2 className="text-xl font-bold text-red-400 mb-2">Á≥ªÁµ±ÁôºÁîü‰æãÂ§ñÈåØË™§</h2>
                <p className="text-slate-400 text-sm mb-6">ÊÇ®ÁöÑÁÄèË¶ΩÂô®Áí∞Â¢ÉÊàñÂø´ÂèñË≥áÊñôÁôºÁîü‰∫ÜË°ùÁ™Å„ÄÇË´ãÈªûÊìä‰∏ãÊñπÊåâÈàïÂº∑Âà∂Ê∏ÖÈô§ÈåØË™§Ë≥áÊñô‰∏¶ÈáçÊñ∞ËºâÂÖ•„ÄÇ</p>
                <button onClick={() => { safeStorage.clear(); window.location.href = window.location.pathname; }} className="px-6 py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-xl transition-colors">Âº∑Âà∂Ê∏ÖÈô§Âø´Âèñ‰∏¶ÈáçÊñ∞ËºâÂÖ•</button>
              </div>
            </div>
          );
        }
        return this.props.children;
      }
    }

    // ==========================================
    // 2. Â§öÂúãË™ûË®ÄËàáÈ†êË®≠Ë≥áÊñô (i18n & Data)
    // ==========================================

    const DICTIONARY = {
      'zh-TW': {
        app: { title: 'HEXA Â±¨ÊÄßÊ®°Êì¨Âô®', subtitle: 'Ê®°Êì¨ÈªûÊìäÂº∑ÂåñÊ©üÁéáÔºåÊàñÊâãÂãïË®≠ÂÆöËµ∑ÈªûËàáÁõÆÊ®ôË®àÁÆóÊúüÊúõËä±Ë≤ªÂçÄÈñì„ÄÇË®≠ÂÆöÊúÉËá™ÂãïË®òÊÜ∂„ÄÇ' },
        ui: { settings: 'Á≥ªÁµ±Ë®≠ÂÆö', lang: 'EN', langSwitch: 'ÂàáÊèõÁÇ∫Ëã±Êñá' },
        core: { title: 'Â±¨ÊÄßÊ†∏ÂøÉ', main: '‰∏ªË¶ÅÂ±¨ÊÄß', add1: 'ÈôÑÂä†Â±¨ÊÄß 1', add2: 'ÈôÑÂä†Â±¨ÊÄß 2', prob: 'Âº∑ÂåñÊ©üÁéá', unenhanced: 'Â∞öÊú™Âº∑Âåñ' },
        stats: { PA_MA: 'Áâ©ÁêÜ/È≠îÊ≥ïÊîªÊìäÂäõ', PD_MD: 'Áâ©ÁêÜ/È≠îÊ≥ïÂÇ∑ÂÆ≥ (%)', CD: 'Ëá¥ÂëΩÊîªÊìäÂÇ∑ÂÆ≥ (%)', MAX_DMG: 'ÊúÄÂ§ßÂÇ∑ÂÆ≥', FD: 'ÊúÄÁµÇÂÇ∑ÂÆ≥ (%)', IED: 'ÁÑ°Ë¶ñÈò≤Á¶¶Áéá (%)' },
        panel: {
          title: 'Ëä±Ë≤ªÁµ±Ë®à', probTableBtn: 'Ê©üÁéáË°®', currentState: 'Áï∂ÂâçÁãÄÊÖã', base: 'Âü∫Á§é', sim: 'Ê®°Êì¨', current: 'Áï∂Ââç(ÁõÆÊ®ô)', calc: 'Á¢éÁâáÊé®ÁÆó',
          baseManual: 'ÊâãÂãïÊé®ÁÆó', simClick: 'Ê®°Êì¨Ëä±Ë≤ª', totalFrag: 'È†ê‰º∞Á¢éÁâá', estProb: 'È†ê‰º∞ÈÅîÊàêÊ©üÁéá', timeMeso: 'Ê•ìÂπ£ËàáÊôÇÈñìËä±Ë≤ª', 
          fragPrice: 'Á¢éÁâáÂñÆÂÉπ', farmRate: 'ÊéõÊ©üÁî¢Âá∫ (ÂÄã/ÊôÇ)', totalMeso: 'Á∏ΩË®àÊ•ìÂπ£', estTime: 'È†ê‰º∞ÊéõÊ©üËÄóÊôÇ', hours: 'Â∞èÊôÇ', nextCost: '‰∏ã‰∏ÄÊ¨°Âº∑ÂåñË≤ªÁî®',
          btnEnhance: 'Âº∑Âåñ', btnMax: 'Â∑≤ÈÅî‰∏äÈôê', btnResetSim: 'ÈáçÁΩÆÊ®°Êì¨', btnResetAll: 'ÈáçÁΩÆÂÖ®ÈÉ®', clearCache: 'Ê∏ÖÈô§Âø´ÂèñË®≠ÂÆö'
        },
        baseline: { set: 'üìç Ë®≠ÁÇ∫Ëµ∑Èªû', clear: '‚ùå ÂèñÊ∂àËµ∑Èªû', tooltip: 'Â∞áÁï∂ÂâçÁãÄÊÖãË®òÈåÑÁÇ∫Ëµ∑ÈªûÔºåÊé®ÁÆóÊú™‰æÜÁöÑÁõÆÊ®ôËä±Ë≤ªËàáÊ©üÁéá„ÄÇ', modeActive: 'Ëµ∑ÈªûÊé®ÁÆóÊ®°ÂºèÂ∑≤ÂïüÁî®', pastCost: 'ÈöéÊÆµ‰∏ÄÔºöËµ∑ÈªûÊ≠∑Âè≤ÊàêÊú¨', futureCost: 'ÈöéÊÆµ‰∫åÔºöÊú™‰æÜÁõÆÊ®ôÊé®ÁÆó' },
        modals: {
          close: 'ÈóúÈñâ', cancel: 'ÂèñÊ∂à', save: 'ÂÑ≤Â≠òË®≠ÂÆö', confirm: 'Á¢∫Ë™ç', tableMain: '‰∏ªË¶ÅÂ±¨ÊÄßË°®', tableAdd: 'ÈôÑÂä†Â±¨ÊÄßË°®', level: 'Á≠âÁ¥ö', value: 'Êï∏ÂÄº',
          probTitle: 'Âº∑ÂåñÊ©üÁéáËàáËä±Ë≤ªÁ∏ΩË°®', probDesc: 'Ê©üÁéáËàáËä±Ë≤ªÁöÜÂèñÊ±∫Êñº„Äå‰∏ªÂ±¨ÊÄß„ÄçÁï∂ÂâçÁ≠âÁ¥ö„ÄÇ',
          colMainLvl: '‰∏ªÂ±¨Á≠âÁ¥ö', colMainProb: '‰∏ªÊ©üÁéá', colAddProb: 'ÂâØÊ©üÁéá(ÂêÑ)', colCost: 'Á¢éÁâáËä±Ë≤ª', probNote: '* Ëã•‰∏ªÂ±¨ÊÄßÈÅîÂà∞ Lv.10ÔºåÊ©üÁéáÂ∞áÂπ≥ÂàÜÁµ¶Êú™ÊªøÁ¥ö‰πãÈôÑÂä†Â±¨ÊÄß„ÄÇ',
          outTitle: 'Ê¨°Êú™‰æÜÂèØËÉΩÁµêÊûú', outDesc: 'ÂæûËµ∑ÈªûÂà∞ÈÅîÊÇ®ÁõÆÂâçË®≠ÂÆöÁãÄÊÖãÁöÑÊ©üÁéáÁÇ∫', colProb: 'ÁôºÁîüÊ©üÁéá', colEstCost: 'È†ê‰º∞È°çÂ§ñÁ¢éÁâáËä±Ë≤ª',
          setTitle: 'Á≥ªÁµ±ÂèÉÊï∏Ëá™Ë®Ç', setDesc: 'ÊÇ®ÂèØÂú®Ê≠§‰øÆÊîπÈÅäÊà≤Â∫ïÂ±§ÁöÑÂº∑ÂåñÊ©üÁéá„ÄÅËä±Ë≤ªËàáÁµ¶‰∫àÁöÑËÉΩÂäõÊï∏ÂÄº',
          tabProb: 'Ê©üÁéáËàáÊ∂àËÄó', tabMain: '‰∏ªÂ±¨ÊÄßË°®', tabAdd: 'ÂâØÂ±¨ÊÄßË°®', tabJson: 'ÈÄ≤ÈöéÂåØÂÖ•',
          setWarn: 'Ë´ãÁ¢∫‰øù ‰∏ªÊ©üÁéá + (ÂâØÊ©üÁéá*2) = 100 ‰ª•ÂÖçË®àÁÆóÈåØË™§„ÄÇ',
          copyUrl: 'Ë§áË£ΩÂàÜ‰∫´ÈÄ£Áµê', copyJson: 'Ë§áË£Ω JSON', jsonTip: 'ÊàñË≤º‰∏ä JSON ‰ª£Á¢ºÂåØÂÖ•Ë®≠ÂÆöÔºö',
          resetDefault: 'ÊÅ¢Âæ©ÂÆòÊñπÈ†êË®≠ÂÄº', replayTour: 'ÈñãÂïüÊñ∞ÊâãÂ∞éË¶Ω',
          confirmClearTitle: 'Ê∏ÖÈô§ÊâÄÊúâÂø´ÂèñË®≠ÂÆö', confirmClearMsg: 'ÈÄôÂ∞áÊúÉÊ∏ÖÈô§ÊÇ®Ë®≠ÂÆöÁöÑ„ÄåÁ¢éÁâáÂñÆÂÉπ„Äç„ÄÅ„ÄåÁî¢Âá∫ÈÄüÁéá„Äç‰ª•ÂèäÊâÄÊúâÂèÉÊï∏ÔºåÁ¢∫ÂÆöË¶ÅÁπºÁ∫åÂóéÔºü',
          storageWarnTitle: '‚ö†Ô∏è ÂÑ≤Â≠òÂäüËÉΩÂèóÈôêÈÄöÁü•', storageWarnDesc: 'ÂÅµÊ∏¨Âà∞ÁÑ°ÁóïÊ®°ÂºèÊàñÈö±ÁßÅË®≠ÂÆöÂ∞ÅÈéñ„ÄÇÊÇ®ÁöÑË®≠ÂÆöÂ∞á‰∏çÊúÉË¢´‰øùÂ≠òÔºÅ',
          sandboxShareWarn: 'ÊÇ®ÁõÆÂâçËôïÊñºÊ≤ôÁõíÈ†êË¶ΩÁí∞Â¢ÉÔºåÁî¢ÁîüÁöÑÁ∂≤ÂùÄÂèØËÉΩÁÑ°Ê≥ïÂú®Â§ñÈÉ®‰ΩøÁî®„ÄÇÂª∫Ë≠∞Áõ¥Êé•Ë§áË£Ω JSON ‰ª£Á¢º„ÄÇ', jsonError: 'JSON Ê†ºÂºèÊúâË™§'
        },
        tour: {
          skip: 'ÈóúÈñâÂ∞éË¶Ω', next: '‰∏ã‰∏ÄÊ≠•', prev: '‰∏ä‰∏ÄÊ≠•', finish: 'ÈñãÂßã‰ΩøÁî®',
          step1Title: 'Ê≠°Ëøé‰ΩøÁî® HEXA Ê®°Êì¨Âô® üéâ', step1Desc: 'ÈÄôÊòØ‰∏ÄÂÄãËÉΩÂπ´Âä©ÊÇ®Ë®àÁÆó„ÄÅÊ®°Êì¨„ÄåÊ•ì‰πãË∞∑ HEXA Â±¨ÊÄß„ÄçËä±Ë≤ªÁöÑÂØ¶Áî®Â∑•ÂÖ∑„ÄÇ',
          step2Title: 'Ë®≠ÂÆöËµ∑ÈªûËàáÊú™‰æÜÊé®ÁÆó üìç', step2Desc: 'ÊÇ®ÂèØ‰ª•ÂÖàÈªûÊìä„ÄåË®≠ÁÇ∫Ëµ∑Èªû„ÄçÔºåÂÜçÁî® `+ / -` Ë®≠ÂÆöÊÇ®ÁöÑ„ÄåÊú™‰æÜÁõÆÊ®ô„ÄçÔºåÁ≥ªÁµ±ÊúÉËá™ÂãïÁÆóÂá∫Ê©üÁéáËàáËä±Ë≤ªÔºÅ',
          step3Title: 'Ëá™Ë®ÇËàáÂàÜ‰∫´ ‚öôÔ∏è', step3Desc: 'ÈªûÊìäÂè≥‰∏äËßíÁöÑ„ÄåÁ≥ªÁµ±Ë®≠ÂÆö„ÄçÔºåÊÇ®ÂèØ‰ª•‰øÆÊîπÊ©üÁéáË°®Ôºå‰∏¶Áî¢ÁîüÂ∞àÂ±¨Á∂≤ÂùÄÂàÜ‰∫´Áµ¶ÊúãÂèã„ÄÇ',
          step4Title: 'Âä†ÂÖ•‰∏ªÁï´Èù¢ (App) üì±', step4Desc: 'üçé iOS (Safari): ÈªûÊìä„ÄåÂàÜ‰∫´„Äç‚ûî„ÄåÂä†ÂÖ•‰∏ªÁï´Èù¢„Äç„ÄÇ\nü§ñ Android (Chrome): ÈªûÊìä„ÄåË®≠ÂÆö(‰∏âÈªû)„Äç‚ûî„ÄåÂä†Âà∞‰∏ªÁï´Èù¢„Äç„ÄÇ'
        }
      },
      'en': {
        app: { title: 'HEXA Stat Simulator', subtitle: 'Simulate clicks or set baselines & targets to estimate future costs.' },
        ui: { settings: 'Settings', lang: 'ÁπÅ‰∏≠', langSwitch: 'Switch to Traditional Chinese' },
        core: { title: 'Hexa Core', main: 'Main Stat', add1: 'Add. Stat 1', add2: 'Add. Stat 2', prob: 'Success Rate', unenhanced: 'Not Enhanced' },
        stats: { PA_MA: 'ATT/MATK', PD_MD: 'Damage (%)', CD: 'Crit Damage (%)', MAX_DMG: 'Max Damage', FD: 'Final Damage (%)', IED: 'Ignore DEF (%)' },
        panel: {
          title: 'Cost Stats', probTableBtn: 'Rates', currentState: 'State', base: 'Base', sim: 'Sim.', current: 'Target', calc: 'Fragments',
          baseManual: 'Manual Est.', simClick: 'Sim. Cost', totalFrag: 'Est. Fragments', estProb: 'Target Probability', timeMeso: 'Meso & Time', 
          fragPrice: 'Frag Price', farmRate: 'Farm Rate (/hr)', totalMeso: 'Total Mesos', estTime: 'Est. Time', hours: 'hrs', nextCost: 'Next Cost',
          btnEnhance: 'Enhance', btnMax: 'Max Level', btnResetSim: 'Reset Sim', btnResetAll: 'Reset All', clearCache: 'Clear Cache'
        },
        baseline: { set: 'üìç Set Baseline', clear: '‚ùå Clear Baseline', tooltip: 'Set your current state as a starting point.', modeActive: 'Baseline Mode Active', pastCost: 'Phase 1: Sunk Cost', futureCost: 'Phase 2: Target Cost' },
        modals: {
          close: 'Close', cancel: 'Cancel', save: 'Save', confirm: 'Confirm', tableMain: 'Main Table', tableAdd: 'Add. Table', level: 'Level', value: 'Value',
          probTitle: 'Rates & Costs', probDesc: 'Based on Main Stat level.', colMainLvl: 'Main Lv.', colMainProb: 'Main %', colAddProb: 'Add. %', colCost: 'Cost', probNote: '* At Lv. 10 Main, probability splits evenly.',
          outTitle: 'Future Outcomes', outDesc: 'Probability to reach your target is', colProb: 'Probability', colEstCost: 'Est. Extra Cost',
          setTitle: 'System Parameters', setDesc: 'Modify underlying game data here.', tabProb: 'Rates', tabMain: 'Main Stats', tabAdd: 'Add. Stats', tabJson: 'Import',
          setWarn: 'Ensure Main % + (Add. % * 2) = 100.', copyUrl: 'Copy Link', copyJson: 'Copy JSON', jsonTip: 'Or paste JSON to import:', resetDefault: 'Restore Defaults', replayTour: 'Welcome Tour',
          confirmClearTitle: 'Clear Settings', confirmClearMsg: 'This will erase all custom settings. Continue?',
          storageWarnTitle: '‚ö†Ô∏è Storage Limited', storageWarnDesc: 'Settings will not be saved in this browser mode.',
          sandboxShareWarn: 'Sandbox environment detected. URL sharing may fail.', jsonError: 'JSON parsing error.'
        },
        tour: {
          skip: 'Close', next: 'Next', prev: 'Prev', finish: 'Start',
          step1Title: 'Welcome üéâ', step1Desc: 'A powerful tool for MapleStory HEXA Stats.',
          step2Title: 'Baseline & Future Targets üìç', step2Desc: 'Click "Set Baseline", then use + / - to set your target.',
          step3Title: 'Customize ‚öôÔ∏è', step3Desc: 'Modify rates and generate shareable links.',
          step4Title: 'Add to Home Screen üì±', step4Desc: 'Add this web app to your Home Screen for the best experience!'
        }
      }
    };

    const STAT_NAMES = Object.keys(DICTIONARY['zh-TW'].stats);
    const STAT_UNITS = { PA_MA: '', PD_MD: '%', CD: '%', MAX_DMG: '', FD: '%', IED: '%' };

    const DEFAULT_CONFIG = {
      levelData: [
        { level: 0, mainProb: 35, addProb: 32.5, cost: 10 }, { level: 1, mainProb: 35, addProb: 32.5, cost: 10 },
        { level: 2, mainProb: 20, addProb: 40, cost: 20 }, { level: 3, mainProb: 20, addProb: 40, cost: 20 },
        { level: 4, mainProb: 20, addProb: 40, cost: 20 }, { level: 5, mainProb: 20, addProb: 40, cost: 20 },
        { level: 6, mainProb: 20, addProb: 40, cost: 20 }, { level: 7, mainProb: 15, addProb: 42.5, cost: 30 },
        { level: 8, mainProb: 10, addProb: 45, cost: 40 }, { level: 9, mainProb: 5, addProb: 47.5, cost: 50 },
        { level: 10, mainProb: 0, addProb: 50, cost: 50 } 
      ],
      mainStats: {
        PA_MA: [350, 500, 700, 900, 1100, 1400, 1700, 2200, 2700, 3400], PD_MD: [1.9, 2.7, 3.8, 4.9, 6.0, 7.6, 9.2, 11.9, 14.6, 18.4],
        CD: [1.8, 2.6, 3.6, 4.6, 5.6, 7.1, 8.6, 11.1, 13.6, 17.1], MAX_DMG: [10000000, 20000000, 30000000, 45000000, 60000000, 75000000, 95000000, 125000000, 180000000, 250000000],
        FD: [1.2, 1.7, 2.4, 3.1, 3.8, 4.8, 5.8, 7.5, 9.2, 11.6], IED: [1.0, 1.4, 2.0, 2.6, 3.2, 4.1, 5.0, 6.5, 8.0, 10.1]
      },
      addStats: {
        PA_MA: [175, 250, 350, 450, 550, 700, 850, 1100, 1350, 1700], PD_MD: [1.0, 1.4, 1.9, 2.5, 3.0, 3.8, 4.6, 6.0, 7.3, 9.2],
        CD: [0.9, 1.3, 1.8, 2.3, 2.8, 3.6, 4.3, 5.6, 6.8, 8.6], MAX_DMG: [5000000, 10000000, 15000000, 22500000, 30000000, 37500000, 47500000, 62500000, 90000000, 125000000],
        FD: [0.6, 0.9, 1.2, 1.6, 1.9, 2.4, 2.9, 3.8, 4.6, 5.8], IED: [0.5, 0.7, 1.0, 1.3, 1.6, 2.1, 2.5, 3.3, 4.0, 5.1]
      }
    };

    const parseConfigSafe = (jsonString) => {
      try {
        const parsed = typeof jsonString === 'string' ? JSON.parse(jsonString) : jsonString;
        if (!parsed) return DEFAULT_CONFIG;
        const merged = { ...DEFAULT_CONFIG };
        if (Array.isArray(parsed.levelData) && parsed.levelData.length === 11) merged.levelData = parsed.levelData;
        if (parsed.mainStats) merged.mainStats = { ...DEFAULT_CONFIG.mainStats, ...parsed.mainStats };
        if (parsed.addStats) merged.addStats = { ...DEFAULT_CONFIG.addStats, ...parsed.addStats };
        return merged;
      } catch (e) { return DEFAULT_CONFIG; }
    };

    const formatNum = (num) => (num === null || num === undefined || isNaN(num)) ? '0' : num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    const formatHours = (spent, rate) => (!rate || rate <= 0 || isNaN(rate) || isNaN(spent)) ? '0.00' : (spent / rate).toFixed(2);

    const getProbabilities = (mainLvl, add1Lvl, add2Lvl, config) => {
      if (mainLvl + add1Lvl + add2Lvl >= 20) return { main: 0, add1: 0, add2: 0 };
      let pMain = config.levelData[mainLvl]?.mainProb ?? 0;
      let pAddBase = config.levelData[mainLvl]?.addProb ?? 0;
      if (mainLvl === 10) pMain = 0;
      let pRest = 100 - pMain;
      let pAdd1 = 0; let pAdd2 = 0;
      if (add1Lvl === 10 && add2Lvl === 10) { pAdd1 = 0; pAdd2 = 0; pMain = 100; } 
      else if (add1Lvl === 10) { pAdd1 = 0; pAdd2 = pRest; } 
      else if (add2Lvl === 10) { pAdd2 = 0; pAdd1 = pRest; } 
      else { pAdd1 = pAddBase; pAdd2 = pAddBase; }
      return { main: pMain, add1: pAdd1, add2: pAdd2 };
    };

    const calculateMinMaxCost = (start, target, config) => {
      if (!start) start = { main: 0, add1: 0, add2: 0 };
      let mainCostSum = 0;
      for (let i = start.main; i < target.main; i++) mainCostSum += (config.levelData[i]?.cost ?? 0);
      const addSteps = (target.add1 - start.add1) + (target.add2 - start.add2);
      const minCost = mainCostSum + addSteps * (config.levelData[start.main]?.cost ?? 0);
      const maxCost = mainCostSum + addSteps * (config.levelData[target.main]?.cost ?? 0);
      return { min: minCost, max: maxCost };
    };

    const calculateOutcomes = (start, target, config) => {
      if (!start) start = { main: 0, add1: 0, add2: 0 };
      const N = (target.main - start.main) + (target.add1 - start.add1) + (target.add2 - start.add2);
      if (N <= 0) return { exactProb: 100, list: [], totalSteps: 0 };

      let dp = Array(11).fill(0).map(() => Array(11).fill(0).map(() => Array(11).fill(0)));
      dp[start.main][start.add1][start.add2] = 1.0;

      for (let step = 0; step < N; step++) {
        let next_dp = Array(11).fill(0).map(() => Array(11).fill(0).map(() => Array(11).fill(0)));
        for (let m = start.main; m <= Math.min(start.main + step, 10); m++) {
          for (let a1 = start.add1; a1 <= Math.min(start.add1 + step, 10); a1++) {
            let a2 = start.main + start.add1 + start.add2 + step - m - a1;
            if (a2 < start.add2 || a2 > 10) continue;
            if (dp[m][a1][a2] > 0) {
              const p = getProbabilities(m, a1, a2, config);
              if (m < 10 && p.main > 0) next_dp[m+1][a1][a2] += dp[m][a1][a2] * (p.main / 100);
              if (a1 < 10 && p.add1 > 0) next_dp[m][a1+1][a2] += dp[m][a1][a2] * (p.add1 / 100);
              if (a2 < 10 && p.add2 > 0) next_dp[m][a1][a2+1] += dp[m][a1][a2] * (p.add2 / 100);
            }
          }
        }
        dp = next_dp;
      }

      let exactProb = dp[target.main]?.[target.add1]?.[target.add2] ? dp[target.main][target.add1][target.add2] * 100 : 0;
      let list = [];
      for (let m = start.main; m <= 10; m++) {
        for (let a1 = start.add1; a1 <= 10; a1++) {
          let a2 = start.main + start.add1 + start.add2 + N - m - a1;
          if (a2 >= start.add2 && a2 <= 10 && dp[m][a1][a2] > 0) list.push({ m, a1, a2, prob: dp[m][a1][a2] * 100 });
        }
      }
      list.sort((a, b) => b.prob - a.prob);
      return { exactProb, list, totalSteps: N };
    };

    function MainApp() {
      const [lang, setLang] = useState(() => {
        const cached = safeStorage.get('hexa_lang');
        if (cached === 'zh-TW' || cached === 'en') return cached;
        try { return navigator.language.startsWith('zh') ? 'zh-TW' : 'en'; } catch (e) { return 'zh-TW'; }
      });

      useEffect(() => { safeStorage.set('hexa_lang', lang); }, [lang]);
      const t = (path) => {
        try {
          const keys = path.split('.'); let val = DICTIONARY[lang] || DICTIONARY['en'];
          for (let k of keys) { if (!val || val[k] === undefined) return path; val = val[k]; }
          return typeof val === 'string' ? val : path;
        } catch (e) { return path; }
      };
      const toggleLang = () => setLang(prev => prev === 'zh-TW' ? 'en' : 'zh-TW');

      const [config, setConfig] = useState(() => {
        try {
          let searchParams = ''; try { searchParams = window.location.search; } catch (e) {} 
          if (searchParams) {
            const params = new URLSearchParams(searchParams);
            if (params.has('config')) return parseConfigSafe(decodeURIComponent(atob(params.get('config'))));
          }
          const cached = safeStorage.get('hexa_sys_config');
          if (cached) return parseConfigSafe(cached); 
        } catch (e) { console.error("Config init error", e); }
        return DEFAULT_CONFIG;
      });

      useEffect(() => {
        safeStorage.set('hexa_sys_config', JSON.stringify(config));
        try { if (window.location.search.includes('config=')) window.history.replaceState({}, '', window.location.pathname); } catch (e) {}
      }, [config]);

      const [fragPrice, setFragPrice] = useState(() => { const c = safeStorage.get('hexa_frag_price'); return c ? Number(c) : 50000000; });
      const [farmRate, setFarmRate] = useState(() => { const c = safeStorage.get('hexa_farm_rate'); return c || "3.0"; });
      useEffect(() => { safeStorage.set('hexa_frag_price', fragPrice.toString()); }, [fragPrice]);
      useEffect(() => { safeStorage.set('hexa_farm_rate', farmRate.toString()); }, [farmRate]);

      const handleFarmRateChange = (e) => {
        let val = e.target.value.replace(/[^0-9.]/g, '');
        if ((val.match(/\./g) || []).length > 1) return;
        if (val.length > 1 && val.startsWith('0') && val[1] !== '.') {
          val = val.replace(/^0+/, '');
          if (val === '') val = '0';
        }
        setFarmRate(val);
      };

      const currentFarmRateNum = Number(farmRate) || 0;

      const [showStorageWarning, setShowStorageWarning] = useState(false);
      const [showTour, setShowTour] = useState(false);
      useEffect(() => { if (!safeStorage.test()) setShowStorageWarning(true); }, []);

      const [baselineLevels, setBaselineLevels] = useState(null); 
      const [levels, setLevels] = useState({ main: 0, add1: 0, add2: 0 }); 
      const [baseLevels, setBaseLevels] = useState({ main: 0, add1: 0, add2: 0 }); 
      const [simulatedSpent, setSimulatedSpent] = useState(0); 
      const [stats, setStats] = useState({ main: 'MAX_DMG', add1: 'FD', add2: 'IED' });
      
      const [viewingTable, setViewingTable] = useState(null); 
      const [showProbModal, setShowProbModal] = useState(false);
      const [showOutcomeModal, setShowOutcomeModal] = useState(false);
      const [showSettingsModal, setShowSettingsModal] = useState(false);
      const [confirmDialog, setConfirmDialog] = useState(null);

      const isBaselineActive = baselineLevels !== null;
      const zeroLevels = { main: 0, add1: 0, add2: 0 };
      const currentStartPoint = isBaselineActive ? baselineLevels : zeroLevels;
      
      const totalLevel = levels.main + levels.add1 + levels.add2;
      const isMaxLevel = totalLevel >= 20;
      const currentCost = config.levelData[levels.main]?.cost ?? 0;
      const probs = getProbabilities(levels.main, levels.add1, levels.add2, config);
      
      const pastCost = isBaselineActive ? calculateMinMaxCost(zeroLevels, baselineLevels, config) : { min: 0, max: 0 };
      const futureBaseCost = calculateMinMaxCost(currentStartPoint, baseLevels, config);
      const totalMinCost = pastCost.min + futureBaseCost.min + simulatedSpent;
      const totalMaxCost = pastCost.max + futureBaseCost.max + simulatedSpent;
      
      const simMainLvl = levels.main - baseLevels.main;
      const simAdd1Lvl = levels.add1 - baseLevels.add1;
      const simAdd2Lvl = levels.add2 - baseLevels.add2;
      
      const outcomes = useMemo(() => calculateOutcomes(currentStartPoint, levels, config), [currentStartPoint, levels, config]);

      const toggleBaseline = () => {
        if (isBaselineActive) setBaselineLevels(null);
        else { setBaselineLevels({ ...levels }); setBaseLevels({ ...levels }); setSimulatedSpent(0); }
      };

      const handleEnhance = () => {
        if (isMaxLevel) return;
        const rand = Math.random() * 100;
        let newLevels = { ...levels };
        if (rand < probs.main) newLevels.main++;
        else if (rand < probs.main + probs.add1) newLevels.add1++;
        else newLevels.add2++;
        setLevels(newLevels);
        setSimulatedSpent(prev => prev + currentCost);
      };

      const handleLevelChange = (slot, delta) => {
        setLevels(prev => {
          let nextVal = prev[slot] + delta;
          const minVal = isBaselineActive ? baselineLevels[slot] : 0;
          if (nextVal < minVal) nextVal = minVal;
          if (nextVal > 10) nextVal = 10;
          let nextLevels = { ...prev, [slot]: nextVal };
          if (nextLevels.main + nextLevels.add1 + nextLevels.add2 > 20) return prev;
          setBaseLevels(nextLevels);
          setSimulatedSpent(0);
          return nextLevels;
        });
      };

      const handleStatChange = (slot, newStat) => {
        setStats(prev => {
          const newStats = { ...prev, [slot]: newStat };
          for (const key in newStats) if (key !== slot && newStats[key] === newStat) newStats[key] = prev[slot];
          return newStats;
        });
      };

      const handleResetSimulation = () => { setLevels(baseLevels); setSimulatedSpent(0); };
      const handleResetAll = () => { setBaselineLevels(null); setLevels({ main: 0, add1: 0, add2: 0 }); setBaseLevels({ main: 0, add1: 0, add2: 0 }); setSimulatedSpent(0); };

      const handleClearCache = () => {
        setConfirmDialog({
          title: t('modals.confirmClearTitle'), message: t('modals.confirmClearMsg'),
          onConfirm: () => {
            safeStorage.rem('hexa_sys_config'); safeStorage.rem('hexa_frag_price'); safeStorage.rem('hexa_farm_rate');
            setConfig(DEFAULT_CONFIG); setFragPrice(50000000); setFarmRate("3.0"); setConfirmDialog(null);
          }
        });
      };

      const getStatDisplayStr = (statKey, level, isMain) => {
        if (level === 0) return t('core.unenhanced');
        const source = isMain ? config.mainStats : config.addStats;
        const val = source?.[statKey]?.[level - 1] ?? 0;
        return `${t(`stats.${statKey}`)} ${formatNum(val)}${STAT_UNITS[statKey] || ''}`;
      };

      const Badge = ({ label, val, isMain }) => (
        <span className={`inline-block min-w-[3rem] px-1 text-center py-0.5 rounded border font-mono text-xs ${isMain ? 'bg-purple-900/40 text-purple-300 border-purple-800/50' : 'bg-blue-900/40 text-blue-300 border-blue-800/50'}`}>
          {label}{val}
        </span>
      );

      return (
        <div className="min-h-screen bg-slate-950 text-slate-200 font-sans p-4 sm:p-8 flex flex-col relative">
          <div className="max-w-5xl mx-auto space-y-6 w-full flex-grow flex flex-col">
            
            {/* Header */}
            <div className="bg-slate-900 border border-slate-800 rounded-2xl p-5 sm:p-6 shadow-xl flex flex-col gap-3">
              <div className="flex justify-between items-start gap-4 flex-wrap">
                <h1 className="text-xl sm:text-2xl font-bold bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent flex items-center gap-2 min-w-min select-none">
                  <Zap className="w-6 h-6 text-purple-400 shrink-0" /> {t('app.title')}
                </h1>
                <div className="flex gap-2 shrink-0">
                  <button onClick={toggleLang} title={t('ui.langSwitch')} className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-300 transition-colors shadow-sm text-sm border border-slate-700">
                      <Globe className="w-4 h-4 shrink-0"/> <span className="font-bold">{t('ui.lang')}</span>
                    </button>
                  <button onClick={() => setShowSettingsModal(true)} className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-300 transition-colors shadow-sm text-sm border border-slate-700">
                      <Settings className="w-4 h-4 shrink-0"/> <span>{t('ui.settings')}</span>
                    </button>
                </div>
              </div>
              <p className="text-slate-400 text-sm max-w-xl select-none">{t('app.subtitle')}</p>
            </div>

            {/* Main Interface */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-grow">
              {/* Left: Hexa Core UI */}
              <div className={`lg:col-span-2 space-y-4 rounded-2xl p-4 -m-4 transition-all duration-300 ${isBaselineActive ? 'bg-indigo-950/20 border border-indigo-900/50 shadow-[0_0_30px_rgba(99,102,241,0.05)]' : 'border border-transparent'}`}>
                <div className="flex justify-between items-end mb-2 px-2">
                  <span className="text-lg font-bold text-slate-300 flex items-center gap-2">
                    {t('core.title')} <span className="text-slate-500 text-sm">({totalLevel}/20)</span>
                  </span>
                  <button onClick={toggleBaseline} title={t('baseline.tooltip')} className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-bold transition-all shadow-sm border select-none ${isBaselineActive ? 'bg-rose-950/40 hover:bg-rose-900/60 text-rose-300 border-rose-800/50' : 'bg-indigo-900/40 hover:bg-indigo-800/60 text-indigo-300 border-indigo-700/50'}`}>
                    {isBaselineActive ? <XCircle className="w-4 h-4"/> : <MapPin className="w-4 h-4"/>}
                    {isBaselineActive ? t('baseline.clear') : t('baseline.set')}
                  </button>
                </div>
                {isBaselineActive && <div className="px-2 pb-1 text-xs text-indigo-400 flex items-center gap-1 animate-pulse select-none"><MapPin className="w-3 h-3" /> {t('baseline.modeActive')} ({baselineLevels.main}, {baselineLevels.add1}, {baselineLevels.add2})</div>}
                
                <StatRow title={t('core.main')} isMain={true} level={levels.main} minLvl={isBaselineActive ? baselineLevels.main : 0} statKey={stats.main} prob={probs.main} t={t} onStatChange={(val) => handleStatChange('main', val)} onLevelChange={(d) => handleLevelChange('main', d)} onInfoClick={() => setViewingTable({ slot: 'main', statKey: stats.main, isMain: true, currentLevel: levels.main })} getStatDisplayStr={getStatDisplayStr} />
                <StatRow title={t('core.add1')} isMain={false} level={levels.add1} minLvl={isBaselineActive ? baselineLevels.add1 : 0} statKey={stats.add1} prob={probs.add1} t={t} onStatChange={(val) => handleStatChange('add1', val)} onLevelChange={(d) => handleLevelChange('add1', d)} onInfoClick={() => setViewingTable({ slot: 'add1', statKey: stats.add1, isMain: false, currentLevel: levels.add1 })} getStatDisplayStr={getStatDisplayStr} />
                <StatRow title={t('core.add2')} isMain={false} level={levels.add2} minLvl={isBaselineActive ? baselineLevels.add2 : 0} statKey={stats.add2} prob={probs.add2} t={t} onStatChange={(val) => handleStatChange('add2', val)} onLevelChange={(d) => handleLevelChange('add2', d)} onInfoClick={() => setViewingTable({ slot: 'add2', statKey: stats.add2, isMain: false, currentLevel: levels.add2 })} getStatDisplayStr={getStatDisplayStr} />
              </div>

              {/* Right: Stats & Controls Panel */}
              <div className="bg-slate-900 border border-slate-800 rounded-2xl p-6 shadow-xl flex flex-col">
                <div className="flex justify-between items-center border-b border-slate-800 pb-3 mb-4 select-none">
                  <h2 className="text-lg font-bold text-slate-300 flex items-center gap-2"><TrendingUp className="w-5 h-5 text-indigo-400" /> {t('panel.title')}</h2>
                  <button onClick={() => setShowProbModal(true)} className="text-slate-400 hover:text-indigo-300 transition-colors flex items-center gap-1 text-sm bg-slate-800 hover:bg-slate-700 px-2 py-1 rounded border border-slate-700"><Info className="w-4 h-4"/> {t('panel.probTableBtn')}</button>
                </div>

                <div className="bg-slate-950/50 border border-slate-800 rounded-xl p-4 mb-4 shadow-inner flex flex-col gap-4 select-none">
                  <div>
                    <span className="text-xs text-slate-400 flex items-center gap-1 mb-2"><Target className="w-3 h-3"/> {t('panel.currentState')}</span>
                    <div className="space-y-1.5 pl-1 sm:pl-2">
                      <div className="flex justify-between items-center text-slate-500 text-sm"><span className="min-w-[4rem]">{t('panel.base')}:</span><div className="flex gap-1 opacity-80"><Badge label="" val={baseLevels.main} isMain={true} /><Badge label="" val={baseLevels.add1} isMain={false} /><Badge label="" val={baseLevels.add2} isMain={false} /></div></div>
                      <div className="flex justify-between items-center text-indigo-400 text-sm"><span className="min-w-[4rem]">{t('panel.sim')}:</span><div className="flex gap-1 font-bold"><Badge label="+" val={simMainLvl} isMain={true} /><Badge label="+" val={simAdd1Lvl} isMain={false} /><Badge label="+" val={simAdd2Lvl} isMain={false} /></div></div>
                      <div className="flex justify-between items-center text-emerald-300 text-sm pt-2 border-t border-slate-800/80"><span className="min-w-[4rem] font-bold">{t('panel.current')}:</span><div className="flex gap-1 font-bold"><Badge label="" val={levels.main} isMain={true} /><Badge label="" val={levels.add1} isMain={false} /><Badge label="" val={levels.add2} isMain={false} /></div></div>
                    </div>
                  </div>

                  <div className="h-px bg-slate-800/80 w-full my-1"></div>

                  <div className="space-y-2 text-sm">
                    <span className="text-xs text-slate-400 flex items-center gap-1 mb-1"><Calculator className="w-3 h-3"/> {t('panel.calc')}</span>
                    <div className="pl-1 sm:pl-2 space-y-2">
                      {isBaselineActive && <div className="flex justify-between text-slate-600 bg-slate-900/50 p-1.5 rounded text-xs border border-slate-800"><span>{t('baseline.pastCost')}:</span><span className="font-mono">{pastCost.min === pastCost.max ? formatNum(pastCost.min) : `${formatNum(pastCost.min)} ~ ${formatNum(pastCost.max)}`}</span></div>}
                      <div className={`flex justify-between ${isBaselineActive ? 'text-indigo-400/80' : 'text-slate-500'}`}><span>{isBaselineActive ? t('baseline.futureCost') : t('panel.baseManual')}:</span><span className="font-mono">{futureBaseCost.min === futureBaseCost.max ? formatNum(futureBaseCost.min) : `${formatNum(futureBaseCost.min)} ~ ${formatNum(futureBaseCost.max)}`}</span></div>
                      <div className="flex justify-between text-indigo-400"><span>{t('panel.simClick')}:</span><span className="font-mono">+{formatNum(simulatedSpent)}</span></div>
                      <div className="flex justify-between items-end pt-2 border-t border-slate-800/50"><span className="text-slate-300 font-bold">{t('panel.totalFrag')}:</span><span className="text-xl font-mono text-emerald-400">{totalMinCost === totalMaxCost ? formatNum(totalMinCost) : `${formatNum(totalMinCost)} ~ ${formatNum(totalMaxCost)}`}</span></div>
                    </div>
                  </div>

                  <div className="h-px bg-slate-800/80 w-full my-1"></div>

                  <div className="flex justify-between items-center">
                    <span className="flex items-center gap-1 text-slate-300 font-medium text-sm">{t('panel.estProb')}:<button onClick={() => setShowOutcomeModal(true)} className="p-1 rounded-full hover:bg-slate-700 transition-colors group" title="Info"><ListChecks className="w-4 h-4 text-emerald-400 group-hover:text-emerald-300" /></button></span>
                    <span className="text-emerald-300 font-mono font-bold bg-emerald-950/40 px-2 py-0.5 rounded text-sm">{outcomes.totalSteps === 0 ? '100.000%' : (outcomes.exactProb < 0.001 ? '< 0.001%' : `${outcomes.exactProb.toFixed(3)}%`)}</span>
                  </div>

                  <div className="h-px bg-slate-800/80 w-full my-1"></div>

                  <div>
                    <span className="text-xs text-slate-400 flex items-center gap-1 mb-3"><Hourglass className="w-3 h-3"/> {t('panel.timeMeso')}</span>
                    <div className="grid grid-cols-2 gap-2 sm:gap-3 bg-slate-900/80 p-2 sm:p-3 rounded-lg border border-slate-700/50 mb-3">
                      <div className="flex flex-col gap-1.5">
                        <label className="text-[11px] text-slate-400 flex items-center gap-1"><Coins className="w-3 h-3"/> {t('panel.fragPrice')}</label>
                        <input type="text" value={formatNum(fragPrice)} onChange={(e) => { const rawVal = e.target.value.replace(/,/g, ''); if (!isNaN(rawVal) && rawVal !== '') setFragPrice(Number(rawVal)); else if (rawVal === '') setFragPrice(0); }} className="bg-slate-950 border border-slate-700 rounded-md px-2 py-1.5 text-sm w-full focus:outline-none focus:border-indigo-500 transition-colors text-slate-200" />
                      </div>
                      <div className="flex flex-col gap-1.5">
                        <label className="text-[11px] text-slate-400 flex items-center gap-1 whitespace-nowrap"><Clock className="w-3 h-3"/> {t('panel.farmRate')}</label>
                        <input type="text" value={farmRate} onChange={handleFarmRateChange} onBlur={() => { if (farmRate === '' || farmRate === '.') setFarmRate('0'); }} className="bg-slate-950 border border-slate-700 rounded-md px-2 py-1.5 text-sm w-full focus:outline-none focus:border-indigo-500 transition-colors text-slate-200" />
                      </div>
                    </div>
                    <div className="space-y-2 mt-1">
                      <div className="bg-slate-900 p-3 rounded-lg border border-slate-800/50 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-1"><div className="text-xs text-slate-500 flex items-center gap-1"><Coins className="w-3.5 h-3.5"/> {t('panel.totalMeso')}</div><div className="text-sm font-mono text-slate-300 text-left sm:text-right">{totalMinCost === totalMaxCost ? formatNum(totalMinCost * fragPrice) : `${formatNum(totalMinCost * fragPrice)} ~ ${formatNum(totalMaxCost * fragPrice)}`}</div></div>
                      <div className="bg-slate-900 p-3 rounded-lg border border-slate-800/50 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-1"><div className="text-xs text-slate-500 flex items-center gap-1"><Clock className="w-3.5 h-3.5"/> {t('panel.estTime')}</div><div className="text-sm font-mono text-slate-300 text-left sm:text-right">{totalMinCost === totalMaxCost ? `${formatHours(totalMinCost, currentFarmRateNum)} ${t('panel.hours')}` : `${formatHours(totalMinCost, currentFarmRateNum)} ~ ${formatHours(totalMaxCost, currentFarmRateNum)} ${t('panel.hours')}`}</div></div>
                    </div>
                  </div>
                </div>

                <div className="mt-auto pt-2 space-y-3">
                  <div className="flex justify-between items-center text-sm px-1 select-none">
                    <span className="text-slate-400">{t('panel.nextCost')}</span>
                    <span className="font-mono text-indigo-300 bg-indigo-950/50 px-2 py-1 rounded flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-indigo-500"></div> {isMaxLevel ? 'MAX' : `${currentCost}`}</span>
                  </div>
                  <button onClick={handleEnhance} disabled={isMaxLevel} className={`w-full py-3.5 rounded-xl font-bold text-lg transition-all flex justify-center items-center gap-2 select-none ${isMaxLevel ? 'bg-slate-800 text-slate-500 cursor-not-allowed' : 'bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white shadow-lg hover:shadow-indigo-500/25 active:scale-[0.98]'}`}>
                    {isMaxLevel ? t('panel.btnMax') : `${t('panel.btnEnhance')} (${totalLevel}/20)`}
                  </button>
                  <div className="flex gap-2 select-none">
                    <button onClick={handleResetSimulation} disabled={simulatedSpent === 0} className="flex-1 py-2 flex justify-center items-center gap-1.5 text-sm text-amber-400 hover:text-amber-300 transition-colors rounded-lg border border-amber-900/30 hover:bg-amber-950/30 active:scale-[0.98] disabled:opacity-30 disabled:cursor-not-allowed whitespace-nowrap"><RotateCcw className="w-4 h-4 shrink-0" /> {t('panel.btnResetSim')}</button>
                    <button onClick={handleResetAll} className="flex-1 py-2 flex justify-center items-center gap-1.5 text-sm text-red-400 hover:text-red-300 transition-colors rounded-lg border border-red-900/30 hover:bg-red-950/30 active:scale-[0.98] whitespace-nowrap"><RefreshCw className="w-4 h-4 shrink-0" /> {t('panel.btnResetAll')}</button>
                  </div>
                </div>
              </div>
            </div>

            {/* Footer */}
            <div className="flex flex-col sm:flex-row justify-between items-center pt-6 mt-4 opacity-70 text-xs text-slate-500">
              <span className="select-none">‚ú® Ê≠§Â∑•ÂÖ∑Áî± Google Gemini ËºîÂä©Áî¢Áîü (Generated by Gemini)</span>
              <button onClick={handleClearCache} className="hover:text-red-400 flex items-center gap-1 transition-colors mt-2 sm:mt-0 p-2">
                <Trash2 className="w-3.5 h-3.5 shrink-0" /> {t('panel.clearCache')}
              </button>
            </div>
          </div>

          {/* Modals */}
          {showStorageWarning && <StorageWarningModal onClose={() => setShowStorageWarning(false)} t={t} />}
          {viewingTable && <StatTableModal info={viewingTable} config={config} onClose={() => setViewingTable(null)} formatNum={formatNum} t={t} />}
          {showProbModal && <ProbabilityModal config={config} onClose={() => setShowProbModal(false)} t={t} />}
          {showOutcomeModal && <OutcomeModal config={config} onClose={() => setShowOutcomeModal(false)} outcomes={outcomes} currentStartPoint={currentStartPoint} currentLevels={levels} formatNum={formatNum} calculateMinMaxCost={calculateMinMaxCost} t={t} />}
          {showSettingsModal && <SettingsModal config={config} setConfig={setConfig} onClose={() => setShowSettingsModal(false)} t={t} onReplayTour={() => { setShowSettingsModal(false); setShowTour(true); }} />}
          {confirmDialog && <ConfirmModal dialog={confirmDialog} onCancel={() => setConfirmDialog(null)} t={t} />}
          {showTour && <TourModal onClose={() => setShowTour(false)} t={t} />}
        </div>
      );
    }

    // --- Sub-Components ---
    function StatRow({ title, isMain, level, minLvl, statKey, prob, onStatChange, onLevelChange, onInfoClick, getStatDisplayStr, t }) {
      const themeColors = isMain ? { bg: 'bg-purple-900/20', border: 'border-purple-800/50', accent: 'bg-purple-500', text: 'text-purple-300' } : { bg: 'bg-blue-900/20', border: 'border-blue-800/50', accent: 'bg-blue-400', text: 'text-blue-300' };
      return (
        <div className={`${themeColors.bg} border ${themeColors.border} rounded-xl p-4 relative overflow-hidden`}>
          <div className={`absolute -right-10 -top-10 w-32 h-32 ${themeColors.accent} opacity-5 blur-3xl rounded-full pointer-events-none`}></div>
          <div className="flex flex-col md:flex-row gap-4 items-start md:items-center relative z-10">
            <div className="w-full md:w-1/3 flex flex-col gap-2">
              <div className={`text-xs font-bold ${themeColors.text} uppercase tracking-wider select-none`}>{title}</div>
              <select value={statKey} onChange={(e) => onStatChange(e.target.value)} className="w-full bg-slate-950/80 border border-slate-700 text-slate-200 text-sm rounded-lg px-3 py-2 focus:outline-none focus:border-slate-500 transition-colors cursor-pointer appearance-none">{STAT_NAMES.map(k => <option key={k} value={k}>{t(`stats.${k}`)}</option>)}</select>
            </div>
            <div className="w-full md:w-2/3 flex flex-col gap-3">
              <div className="flex justify-between items-center select-none">
                <div className="flex items-center gap-2"><span className="text-slate-200 font-medium text-sm sm:text-base">{getStatDisplayStr(statKey, level, isMain)}</span><button onClick={onInfoClick} type="button" className="p-1 rounded-full hover:bg-slate-800 transition-colors group" title="Info"><Info className="w-4 h-4 text-indigo-400 group-hover:text-indigo-300" /></button></div>
                <div className="text-xs text-slate-400 flex items-center gap-1">{t('core.prob')}: <span className="font-mono text-slate-200">{prob.toFixed(1)}%</span></div>
              </div>
              <div className="flex items-center gap-3">
                <button type="button" onClick={() => onLevelChange(-1)} disabled={level <= minLvl} className="w-8 h-8 shrink-0 rounded-full bg-slate-800 flex items-center justify-center text-slate-400 hover:text-white hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors select-none"> - </button>
                <div className="flex-1 h-3 bg-slate-950 rounded-full overflow-hidden border border-slate-800/50 flex relative">
                  {[...Array(10)].map((_, i) => (<div key={i} className={`flex-1 border-r border-slate-900 last:border-0 ${i < minLvl ? 'bg-indigo-900 opacity-60' : i < level ? themeColors.accent : 'bg-transparent'}`}></div>))}
                  {minLvl > 0 && <div className="absolute top-0 bottom-0 border-r-2 border-indigo-400 z-10" style={{left: `${minLvl * 10}%`}}></div>}
                </div>
                <button type="button" onClick={() => onLevelChange(1)} disabled={level >= 10} className="w-8 h-8 shrink-0 rounded-full bg-slate-800 flex items-center justify-center text-slate-400 hover:text-white hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors select-none"> + </button>
                <div className="w-14 min-w-[3.5rem] whitespace-nowrap text-center font-mono font-bold text-slate-300 text-sm select-none">Lv. {level}</div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function StorageWarningModal({ onClose, t }) {
      return (
        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" onClick={onClose}>
          <div className="bg-slate-900 border border-amber-700/50 rounded-2xl w-full max-w-md shadow-2xl overflow-hidden p-6 text-center" onClick={e => e.stopPropagation()}>
            <AlertTriangle className="w-12 h-12 text-amber-500 mx-auto mb-4" />
            <h3 className="text-xl font-bold text-slate-200 mb-3">{t('modals.storageWarnTitle')}</h3>
            <p className="text-sm text-slate-400 mb-6 whitespace-pre-line leading-relaxed">{t('modals.storageWarnDesc')}</p>
            <button onClick={onClose} type="button" className="w-full py-3 rounded-xl bg-amber-600 hover:bg-amber-500 text-white font-bold transition-colors">{t('modals.confirm')}</button>
          </div>
        </div>
      );
    }

    function StatTableModal({ info, config, onClose, formatNum, t }) {
      const { isMain, currentLevel } = info;
      const [selectedStat, setSelectedStat] = useState(info.statKey);
      const rawTableData = isMain ? config.mainStats[selectedStat] : config.addStats[selectedStat];
      const tableData = Array.isArray(rawTableData) ? rawTableData : Array(10).fill(0);
      const unit = STAT_UNITS[selectedStat] || '';
      return (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" onClick={onClose}>
          <div className="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden" onClick={e => e.stopPropagation()}>
            <div className="p-4 border-b border-slate-800 bg-slate-950/80">
              <div className="flex justify-between items-center mb-3">
                <h3 className="font-bold text-slate-200 flex items-center gap-2"><Info className="w-5 h-5 text-indigo-400"/> {isMain ? t('modals.tableMain') : t('modals.tableAdd')}</h3>
                <button type="button" onClick={onClose} className="text-slate-500 hover:text-slate-300 p-1"><X className="w-5 h-5" /></button>
              </div>
              <select value={selectedStat} onChange={(e) => setSelectedStat(e.target.value)} className="w-full bg-slate-900 border border-slate-700 text-slate-300 text-sm rounded-lg px-3 py-2 focus:outline-none focus:border-indigo-500">{STAT_NAMES.map(k => <option key={k} value={k}>{t(`stats.${k}`)}</option>)}</select>
            </div>
            <div className="p-4 max-h-[60vh] overflow-y-auto">
              <div className="grid grid-cols-2 text-sm rounded-lg overflow-hidden border border-slate-800">
                <div className="font-bold text-slate-400 bg-slate-950 border-b border-r border-slate-800 py-2.5 text-center">{t('modals.level')}</div>
                <div className="font-bold text-slate-400 bg-slate-950 border-b border-slate-800 py-2.5 text-center">{t('modals.value')}</div>
                {tableData.map((val, idx) => {
                  const isCurrent = (idx + 1) === currentLevel && info.statKey === selectedStat;
                  return (
                    <React.Fragment key={idx}>
                      <div className={`py-2 text-center border-b border-r border-slate-800/50 flex items-center justify-center gap-2 ${isCurrent ? 'bg-indigo-900/40 text-indigo-300 font-bold' : 'text-slate-400'}`}>{isCurrent && <div className="w-1.5 h-1.5 rounded-full bg-indigo-400"></div>} Lv. {idx + 1}</div>
                      <div className={`py-2 text-center border-b border-slate-800/50 font-mono ${isCurrent ? 'bg-indigo-900/40 text-indigo-200 font-bold' : 'text-slate-300'}`}>{formatNum(val)}{unit}</div>
                    </React.Fragment>
                  );
                })}
              </div>
            </div>
          </div>
        </div>
      );
    }

    function ProbabilityModal({ config, onClose, t }) {
      const [sortConfig, setSortConfig] = useState({ key: 'level', direction: 'asc' });
      const sortedData = useMemo(() => {
        let items = Array.isArray(config.levelData) ? [...config.levelData] : [];
        items.sort((a, b) => { if (a[sortConfig.key] < b[sortConfig.key]) return sortConfig.direction === 'asc' ? -1 : 1; if (a[sortConfig.key] > b[sortConfig.key]) return sortConfig.direction === 'asc' ? 1 : -1; return 0; });
        return items;
      }, [config.levelData, sortConfig]);
      const requestSort = (k) => setSortConfig({ key: k, direction: sortConfig.key === k && sortConfig.direction === 'asc' ? 'desc' : 'asc' });
      const getSortIcon = (k) => sortConfig.key !== k ? <ArrowUpDown className="w-3 h-3 text-slate-600 opacity-0 group-hover:opacity-100 transition-opacity inline" /> : <ArrowUpDown className={`w-3 h-3 text-indigo-400 ${sortConfig.direction === 'desc' ? 'rotate-180' : ''} transition-transform inline`} />;
      return (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" onClick={onClose}>
          <div className="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden flex flex-col max-h-[80vh]" onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center p-5 border-b border-slate-800 bg-slate-950/80 shrink-0">
              <div><h3 className="font-bold text-slate-200 text-lg flex items-center gap-2"><TrendingUp className="w-5 h-5 text-indigo-400"/> {t('modals.probTitle')}</h3><p className="text-xs text-slate-400 mt-1">{t('modals.probDesc')}</p></div>
              <button type="button" onClick={onClose} className="text-slate-500 hover:text-slate-300 p-2 bg-slate-800 rounded-full"><X className="w-5 h-5" /></button>
            </div>
            <div className="overflow-x-auto overflow-y-auto relative bg-slate-900">
              <table className="w-full text-sm text-left whitespace-nowrap">
                <thead className="text-xs text-slate-400 uppercase">
                  <tr>
                    <th onClick={() => requestSort('level')} className="sticky top-0 z-20 bg-slate-950 px-4 py-3 cursor-pointer group hover:bg-slate-900">{t('modals.colMainLvl')} {getSortIcon('level')}</th>
                    <th onClick={() => requestSort('mainProb')} className="sticky top-0 z-20 bg-slate-950 px-4 py-3 cursor-pointer group hover:bg-slate-900">{t('modals.colMainProb')} {getSortIcon('mainProb')}</th>
                    <th onClick={() => requestSort('addProb')} className="sticky top-0 z-20 bg-slate-950 px-4 py-3 cursor-pointer group hover:bg-slate-900">{t('modals.colAddProb')} {getSortIcon('addProb')}</th>
                    <th onClick={() => requestSort('cost')} className="sticky top-0 z-20 bg-slate-950 px-4 py-3 cursor-pointer group hover:bg-slate-900">{t('modals.colCost')} {getSortIcon('cost')}</th>
                  </tr>
                </thead>
                <tbody>
                  {sortedData.map((row, idx) => (
                    <tr key={idx} className="bg-slate-900 border-b border-slate-800/50 hover:bg-slate-800/50">
                      <td className="px-4 py-3 font-mono font-medium text-slate-300">Lv. {row?.level ?? 0}</td>
                      <td className="px-4 py-3 font-mono text-purple-300">{row?.mainProb ?? 0}%</td>
                      <td className="px-4 py-3 font-mono text-blue-300">{row?.addProb ?? 0}%</td>
                      <td className="px-4 py-3 font-mono text-indigo-300">{row?.cost ?? 0}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            <div className="p-4 border-t border-slate-800 bg-slate-950/80 shrink-0 text-xs text-slate-500">{t('modals.probNote')}</div>
          </div>
        </div>
      );
    }

    function OutcomeModal({ config, onClose, outcomes, currentStartPoint, currentLevels, formatNum, calculateMinMaxCost, t }) {
      const [sortConfig, setSortConfig] = useState({ key: 'prob', direction: 'desc' });
      const containerRef = useRef(null);
      const currentRowRef = useRef(null);
      const sortedData = useMemo(() => {
        let items = Array.isArray(outcomes.list) ? [...outcomes.list] : [];
        items.sort((a, b) => { if (a[sortConfig.key] < b[sortConfig.key]) return sortConfig.direction === 'asc' ? -1 : 1; if (a[sortConfig.key] > b[sortConfig.key]) return sortConfig.direction === 'asc' ? 1 : -1; return 0; });
        return items;
      }, [outcomes.list, sortConfig]);

      useEffect(() => {
        const timer = setTimeout(() => {
          if (currentRowRef.current && containerRef.current) {
            const relativeTop = currentRowRef.current.getBoundingClientRect().top - containerRef.current.getBoundingClientRect().top;
            containerRef.current.scrollTo({ top: containerRef.current.scrollTop + relativeTop - 100, behavior: 'smooth' });
          }
        }, 100);
        return () => clearTimeout(timer);
      }, []);
      const requestSort = (k) => setSortConfig({ key: k, direction: sortConfig.key === k && sortConfig.direction === 'asc' ? 'desc' : 'asc' });
      return (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" onClick={onClose}>
          <div className="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh]" onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center p-5 border-b border-slate-800 bg-slate-950/80 shrink-0">
              <div><h3 className="font-bold text-slate-200 text-lg flex items-center gap-2"><ListChecks className="w-5 h-5 text-emerald-400"/> {outcomes.totalSteps} {t('modals.outTitle')}</h3><p className="text-xs text-slate-400 mt-1">{t('modals.outDesc')}: <span className="font-bold text-emerald-300">{outcomes.exactProb.toFixed(3)}%</span></p></div>
              <button type="button" onClick={onClose} className="text-slate-500 hover:text-slate-300 p-2 bg-slate-800 rounded-full"><X className="w-5 h-5" /></button>
            </div>
            <div ref={containerRef} className="overflow-x-auto overflow-y-auto relative bg-slate-900 scroll-smooth">
              <table className="w-full text-sm text-center whitespace-nowrap">
                <thead className="text-xs text-slate-400 uppercase">
                  <tr>
                    <th onClick={() => requestSort('m')} className="sticky top-0 z-20 bg-slate-950 px-2 py-3 cursor-pointer hover:bg-slate-900 shadow-[0_1px_0_0_#1e293b]">{t('core.main')}</th>
                    <th onClick={() => requestSort('a1')} className="sticky top-0 z-20 bg-slate-950 px-2 py-3 cursor-pointer hover:bg-slate-900 shadow-[0_1px_0_0_#1e293b]">{t('core.add1')}</th>
                    <th onClick={() => requestSort('a2')} className="sticky top-0 z-20 bg-slate-950 px-2 py-3 cursor-pointer hover:bg-slate-900 shadow-[0_1px_0_0_#1e293b]">{t('core.add2')}</th>
                    <th onClick={() => requestSort('prob')} className="sticky top-0 z-20 bg-slate-950 px-4 py-3 cursor-pointer hover:bg-slate-900 shadow-[0_1px_0_0_#1e293b] text-right border-l border-slate-800">{t('modals.colProb')}</th>
                    <th className="sticky top-0 z-20 bg-slate-950 px-4 py-3 shadow-[0_1px_0_0_#1e293b] text-right border-l border-slate-800">{t('modals.colEstCost')}</th>
                  </tr>
                </thead>
                <tbody>
                  {sortedData.map((row, idx) => {
                    const isCurrent = row.m === currentLevels.main && row.a1 === currentLevels.add1 && row.a2 === currentLevels.add2;
                    const cost = calculateMinMaxCost(currentStartPoint, {main: row.m, add1: row.a1, add2: row.a2}, config);
                    const costStr = cost.min === cost.max ? formatNum(cost.min) : `${formatNum(cost.min)} ~ ${formatNum(cost.max)}`;
                    return (
                      <tr key={idx} ref={isCurrent ? currentRowRef : null} className={`border-b border-slate-800/50 transition-colors ${isCurrent ? 'bg-emerald-900/40 outline outline-1 outline-emerald-500/50' : 'bg-slate-900 hover:bg-slate-800/50'}`}>
                        <td className={`px-2 py-2 font-mono ${isCurrent ? 'text-emerald-300 font-bold' : 'text-slate-300'}`}>{row.m}</td>
                        <td className={`px-2 py-2 font-mono ${isCurrent ? 'text-emerald-300 font-bold' : 'text-slate-300'}`}>{row.a1}</td>
                        <td className={`px-2 py-2 font-mono ${isCurrent ? 'text-emerald-300 font-bold' : 'text-slate-300'}`}>{row.a2}</td>
                        <td className={`px-4 py-2 font-mono text-right border-l border-slate-800/50 ${isCurrent ? 'text-emerald-300 font-bold' : 'text-slate-400'}`}>{row.prob < 0.001 ? '< 0.001' : row.prob.toFixed(3)}%</td>
                        <td className={`px-4 py-2 font-mono text-right border-l border-slate-800/50 ${isCurrent ? 'text-emerald-300 font-bold' : 'text-slate-400'}`}>+{costStr}</td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      );
    }

    function SettingsModal({ config, setConfig, onClose, t, onReplayTour }) {
      const [activeTab, setActiveTab] = useState('prob');
      const [localConfig, setLocalConfig] = useState(JSON.parse(JSON.stringify(config))); 
      const [jsonText, setJsonText] = useState(JSON.stringify(config, null, 2));
      const [selectedStat, setSelectedStat] = useState('MAX_DMG');
      const [copyStatus, setCopyStatus] = useState('');
      const [shareWarn, setShareWarn] = useState(false);
      const [jsonError, setJsonError] = useState(false);

      const handleConfigChange = (path, value) => {
        let newVal = parseFloat(value); if (isNaN(newVal)) newVal = 0;
        const newConfig = { ...localConfig }; let current = newConfig;
        for (let i = 0; i < path.length - 1; i++) current = current[path[i]];
        current[path[path.length - 1]] = newVal;
        setLocalConfig(newConfig); setJsonText(JSON.stringify(newConfig, null, 2));
      };
      const handleJsonChange = (e) => { setJsonText(e.target.value); try { setLocalConfig(JSON.parse(e.target.value)); } catch (e) {} };
      const handleSave = () => { try { setConfig(parseConfigSafe(JSON.parse(jsonText))); onClose(); } catch (e) { setJsonError(true); setTimeout(() => setJsonError(false), 3000); } };
      const handleResetDefault = () => { setLocalConfig(JSON.parse(JSON.stringify(DEFAULT_CONFIG))); setJsonText(JSON.stringify(DEFAULT_CONFIG, null, 2)); };
      const copyToClipboard = (text, type) => {
        const textArea = document.createElement("textarea"); textArea.value = text; document.body.appendChild(textArea); textArea.select();
        try { document.execCommand('copy'); setCopyStatus(type); setTimeout(() => setCopyStatus(''), 2000); } catch (err) {}
        document.body.removeChild(textArea);
      };
      const handleShareLink = () => {
        setShareWarn(true); setTimeout(() => setShareWarn(false), 5000);
      };

      const tabs = [{ id: 'prob', label: t('modals.tabProb') }, { id: 'mainStat', label: t('modals.tabMain') }, { id: 'addStat', label: t('modals.tabAdd') }, { id: 'json', label: t('modals.tabJson') }];

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" onClick={onClose}>
          <div className="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center p-5 border-b border-slate-800 bg-slate-950/80 shrink-0">
              <div><h3 className="font-bold text-slate-200 text-lg flex items-center gap-2"><Settings className="w-5 h-5 text-indigo-400"/> {t('modals.setTitle')}</h3><p className="text-xs text-slate-400 mt-1">{t('modals.setDesc')}</p></div>
              <button type="button" onClick={onClose} className="text-slate-500 hover:text-slate-300 p-2 bg-slate-800 rounded-full"><X className="w-5 h-5" /></button>
            </div>
            <div className="flex border-b border-slate-800 bg-slate-950/50 px-4 pt-2 overflow-x-auto shrink-0 hide-scrollbar">
              {tabs.map(tab => (<button key={tab.id} onClick={() => setActiveTab(tab.id)} type="button" className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors whitespace-nowrap ${activeTab === tab.id ? 'border-indigo-500 text-indigo-300' : 'border-transparent text-slate-400 hover:text-slate-300'}`}>{tab.label}</button>))}
            </div>
            <div className="overflow-y-auto p-5 bg-slate-900 flex-grow">
              {activeTab === 'prob' && (
                <div className="space-y-4">
                  <div className="text-xs text-amber-500 bg-amber-950/20 p-3 rounded-lg border border-amber-900/50 flex items-start gap-2"><AlertTriangle className="w-4 h-4 shrink-0 mt-0.5"/><p>{t('modals.setWarn')}</p></div>
                  <div className="grid grid-cols-4 gap-2 text-[11px] sm:text-xs font-bold text-slate-400 text-center pb-2 border-b border-slate-800"><div>{t('modals.colMainLvl')}</div><div>{t('modals.colMainProb')}</div><div>{t('modals.colAddProb')}</div><div>{t('modals.colCost')}</div></div>
                  {localConfig.levelData.map((data, idx) => (
                    <div key={idx} className="grid grid-cols-4 gap-3 items-center">
                      <div className="text-center font-mono text-slate-300 text-sm">Lv. {data.level}</div>
                      <input type="number" step="0.1" value={data.mainProb} onChange={e => handleConfigChange(['levelData', idx, 'mainProb'], e.target.value)} className="bg-slate-950 border border-slate-700 rounded px-2 py-1 text-center text-sm focus:border-indigo-500" />
                      <input type="number" step="0.1" value={data.addProb} onChange={e => handleConfigChange(['levelData', idx, 'addProb'], e.target.value)} className="bg-slate-950 border border-slate-700 rounded px-2 py-1 text-center text-sm focus:border-indigo-500" />
                      <input type="number" value={data.cost} onChange={e => handleConfigChange(['levelData', idx, 'cost'], e.target.value)} className="bg-slate-950 border border-slate-700 rounded px-2 py-1 text-center text-sm focus:border-indigo-500" />
                    </div>
                  ))}
                </div>
              )}
              {(activeTab === 'mainStat' || activeTab === 'addStat') && (
                <div className="space-y-4">
                  <select value={selectedStat} onChange={(e) => setSelectedStat(e.target.value)} className="w-full bg-slate-950 border border-slate-700 text-slate-200 text-sm rounded-lg px-3 py-2 focus:outline-none focus:border-indigo-500">{STAT_NAMES.map(k => <option key={k} value={k}>{t(`stats.${k}`)} ({STAT_UNITS[k] || 'Val'})</option>)}</select>
                    <div className="grid grid-cols-2 sm:grid-cols-5 gap-3">
                      {(activeTab === 'mainStat' ? localConfig.mainStats : localConfig.addStats)[selectedStat].map((val, idx) => (
                        <div key={idx} className="flex flex-col gap-1"><label className="text-xs text-slate-500 pl-1">Lv. {idx + 1}</label><input type="number" step="0.1" value={val} onChange={e => handleConfigChange([activeTab === 'mainStat' ? 'mainStats' : 'addStats', selectedStat, idx], e.target.value)} className="bg-slate-950 border border-slate-700 rounded px-2 py-1.5 text-sm focus:border-indigo-500 w-full" /></div>
                      ))}
                    </div>
                </div>
              )}
              {activeTab === 'json' && (
                <div className="space-y-4 h-full flex flex-col">
                  <div className="flex flex-col sm:flex-row gap-2">
                    <button onClick={handleShareLink} type="button" className="flex-1 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg flex items-center justify-center gap-2 text-sm transition-colors">{copyStatus === 'link' ? <CheckCircle className="w-4 h-4" /> : <Link className="w-4 h-4" />} {t('modals.copyUrl')}</button>
                    <button onClick={() => copyToClipboard(jsonText, 'json')} type="button" className="flex-1 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 border border-slate-700 rounded-lg flex items-center justify-center gap-2 text-sm transition-colors">{copyStatus === 'json' ? <CheckCircle className="w-4 h-4 text-emerald-400" /> : <Copy className="w-4 h-4" />} {t('modals.copyJson')}</button>
                  </div>
                  {shareWarn && <div className="text-xs text-amber-400 bg-amber-950/30 p-2 rounded border border-amber-900/50 flex items-start gap-1"><AlertTriangle className="w-3.5 h-3.5 shrink-0"/> {t('modals.sandboxShareWarn')}</div>}
                  <div className="text-xs text-slate-400 mt-2">{t('modals.jsonTip')}</div>
                  <textarea value={jsonText} onChange={handleJsonChange} spellCheck="false" className="w-full flex-grow min-h-[250px] bg-slate-950 border border-slate-700 rounded-lg p-3 text-xs font-mono text-emerald-400 focus:outline-none focus:border-indigo-500 resize-none" />
                </div>
              )}
            </div>
            <div className="p-4 border-t border-slate-800 bg-slate-950/80 shrink-0 flex flex-col sm:flex-row justify-between items-center gap-4">
              <div className="flex w-full sm:w-auto gap-2">
                  <button type="button" onClick={onReplayTour} className="flex-1 sm:flex-none text-slate-400 hover:text-indigo-400 text-xs sm:text-sm px-3 py-2 rounded-lg border border-slate-800 hover:border-indigo-900 transition-colors">{t('modals.replayTour')}</button>
                  <button type="button" onClick={handleResetDefault} className="flex-1 sm:flex-none text-slate-400 hover:text-slate-200 text-xs sm:text-sm px-3 py-2 rounded-lg hover:bg-slate-800 transition-colors">{t('modals.resetDefault')}</button>
              </div>
              <div className="flex w-full sm:w-auto gap-2 items-center">
                <button type="button" onClick={onClose} className="flex-1 sm:flex-none px-4 py-2 rounded-lg text-sm text-slate-400 hover:bg-slate-800 transition-colors">{t('modals.cancel')}</button>
                <div className="flex flex-col items-center flex-1 sm:flex-none">
                  <button type="button" onClick={handleSave} className="w-full sm:w-auto px-6 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-bold shadow-lg shadow-indigo-500/20 transition-all">{t('modals.save')}</button>
                  {jsonError && <span className="absolute bottom-1 right-6 text-[10px] text-red-400">{t('modals.jsonError')}</span>}
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function ConfirmModal({ dialog, onCancel, t }) {
      return (
        <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" onClick={onCancel}>
          <div className="bg-slate-900 border border-red-900/50 rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden p-6 text-center transform transition-all scale-100" onClick={e => e.stopPropagation()}>
            <div className="w-12 h-12 bg-red-900/30 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 border border-red-800/50"><AlertTriangle className="w-6 h-6" /></div>
            <h3 className="text-lg font-bold text-slate-200 mb-2">{dialog.title}</h3>
            <p className="text-sm text-slate-400 mb-6">{dialog.message}</p>
            <div className="flex gap-3">
              <button type="button" onClick={onCancel} className="flex-1 py-2.5 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 text-sm font-medium transition-colors">{t('modals.cancel')}</button>
              <button type="button" onClick={dialog.onConfirm} className="flex-1 py-2.5 rounded-xl bg-red-600 hover:bg-red-500 text-white text-sm font-bold shadow-lg shadow-red-600/20 transition-colors">{t('modals.confirm')}</button>
            </div>
          </div>
        </div>
      );
    }

    function TourModal({ onClose, t }) {
      const [step, setStep] = useState(0);
      const stepsData = [
        { icon: <Zap className="w-10 h-10 text-purple-400"/>, title: t('tour.step1Title'), desc: t('tour.step1Desc') },
        { icon: <MapPin className="w-10 h-10 text-emerald-400"/>, title: t('tour.step2Title'), desc: t('tour.step2Desc') },
        { icon: <Settings className="w-10 h-10 text-indigo-400"/>, title: t('tour.step3Title'), desc: t('tour.step3Desc') },
        { icon: <Smartphone className="w-10 h-10 text-blue-400"/>, title: t('tour.step4Title'), desc: t('tour.step4Desc') },
      ];

      return (
        <div className="fixed inset-0 z-[80] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" onClick={onClose}>
          <div className="bg-slate-900 border border-slate-700 rounded-3xl w-full max-w-md shadow-2xl overflow-hidden flex flex-col relative" onClick={e => e.stopPropagation()}>
            <div className="absolute top-0 right-0 w-40 h-40 bg-indigo-500/10 blur-3xl rounded-full pointer-events-none"></div>
            <div className="absolute bottom-0 left-0 w-40 h-40 bg-purple-500/10 blur-3xl rounded-full pointer-events-none"></div>
            <button type="button" onClick={onClose} className="absolute top-4 right-4 text-slate-500 hover:text-slate-300 z-20 p-2"><X className="w-6 h-6"/></button>
            <div className="p-8 pb-4 flex flex-col items-center text-center relative z-10 mt-4">
              <div className="w-20 h-20 bg-slate-800 border border-slate-700 rounded-full flex items-center justify-center mb-6 shadow-lg">{stepsData[step].icon}</div>
              <h2 className="text-xl font-bold text-slate-200 mb-3">{stepsData[step].title}</h2>
              <p className="text-slate-400 text-sm whitespace-pre-line leading-relaxed min-h-[5rem]">{stepsData[step].desc}</p>
            </div>
            <div className="flex justify-center gap-2 mb-6 relative z-10">
              {stepsData.map((_, i) => <div key={i} className={`w-2 h-2 rounded-full transition-colors ${i === step ? 'bg-indigo-500' : 'bg-slate-800'}`}></div>)}
            </div>
            <div className="p-4 border-t border-slate-800 bg-slate-950/50 flex justify-between items-center gap-4 relative z-10">
              <button type="button" onClick={onClose} className="text-sm text-slate-500 hover:text-slate-300 font-medium px-2">{t('tour.skip')}</button>
              <div className="flex gap-2">
                {step > 0 && <button type="button" onClick={() => setStep(s => s - 1)} className="p-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 transition-colors"><ChevronLeft className="w-5 h-5" /></button>}
                {step < stepsData.length - 1 ? (
                  <button type="button" onClick={() => setStep(s => s + 1)} className="px-6 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-bold shadow-lg shadow-indigo-500/20 transition-all flex items-center gap-1">{t('tour.next')} <ChevronRight className="w-4 h-4" /></button>
                ) : (
                  <button type="button" onClick={onClose} className="px-6 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-bold shadow-lg shadow-emerald-500/20 transition-all">{t('tour.finish')}</button>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    }

    const root = createRoot(document.getElementById('root'));
    root.render(<ErrorBoundary><MainApp /></ErrorBoundary>);
  </script>
</body>
</html>
